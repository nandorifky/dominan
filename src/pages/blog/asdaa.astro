---
export const prerender = false; // WAJIB: Mode Server Side Rendering (SSR)
import slugify from 'slugify';
import { getEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

// 1. Ambil Slug langsung dari URL (Bukan getStaticPaths lagi)
const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

// 2. Fetch Data Post
const post = await getEntry('posts', slug);

if (!post) {
  return Astro.redirect('/404');
}

const { Content } = await post.render();
const data = post.data;

// --- LOGIC AMBIL DATA AUTHOR ---
let authorData = null;
if (data.author) {
  const authorEntry = await getEntry(data.author);
  if (authorEntry) {
    authorData = authorEntry.data;
  }
}

// --- LOGIC RATING REAL-TIME (SERVER SIDE - KV) ---
// Default value jika belum ada yang vote / KV belum connect
let currentRating = 4.8; 
let reviewCount = 12;

// Cek koneksi ke Cloudflare KV
if (Astro.locals.runtime?.env?.RATINGS) {
    try {
        const kvData = await Astro.locals.runtime.env.RATINGS.get(slug, { type: 'json' });
        if (kvData && kvData.count > 0) {
            // Rumus: Total Nilai / Jumlah Voter
            const avg = (kvData.total / kvData.count).toFixed(1);
            currentRating = parseFloat(avg);
            reviewCount = kvData.count;
        }
    } catch (e) {
        console.error("KV Read Error:", e);
        // Fail silent: tetap render halaman dengan default rating
    }
}
// ------------------------------------------------

const pageTitle = data.seo?.metaTitle || data.title;
const shareImage = data.seo?.ogImage || data.coverImage || '/og-default.jpg';
const breadcrumbName = data.seo?.breadcrumbTitle || data.title;
const categorySlug = slugify(data.category, { lower: true }); // Slug kategori untuk link

// --- SCHEMA JSON-LD UPDATE (RICH RESULT) ---
const schemaOrgJSON = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "BreadcrumbList",
      "itemListElement": [
        { "@type": "ListItem", "position": 1, "name": "Home", "item": Astro.site },
        { "@type": "ListItem", "position": 2, "name": "Blog", "item": new URL("/blog", Astro.site) },
        { "@type": "ListItem", "position": 3, "name": data.category, "item": new URL(`/blog/${categorySlug}`, Astro.site) },
        { "@type": "ListItem", "position": 4, "name": breadcrumbName, "item": Astro.url.href }
      ]
    },
    {
        "@type": "BlogPosting",
      "headline": pageTitle,
      "articleSection": data.category, // Tambahkan kategori ke schema
      "image": new URL(shareImage, Astro.site),
      "datePublished": data.publishedDate,
      "dateModified": data.updatedDate || data.publishedDate,
      "author": authorData ? {
          "@type": "Person",
          "name": authorData.name,
          "url": authorData.social?.website || Astro.site
      } : { "@type": "Organization", "name": "Dominan Web" },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": currentRating,
        "reviewCount": reviewCount,
        "bestRating": "5",
        "worstRating": "1"
      }
    }
  ]
};
---

<Layout title={pageTitle}>
  <Fragment slot="head">
     <script type="application/ld+json" set:html={JSON.stringify(schemaOrgJSON)} />
  </Fragment>

  <article class="bg-white min-h-screen">
    {/* Header */}
    <header class="py-16 md:py-24 border-b-3 border-dom-black bg-zinc-50 text-center relative overflow-hidden">
        <div class="container mx-auto px-6 max-w-4xl relative z-10">
            <nav class="flex justify-center items-center gap-2 text-xs font-bold uppercase tracking-widest text-gray-500 mb-8">
                <a href="/" class="hover:text-black hover:underline">Home</a>
                <span>/</span>
                <a href="/blog" class="hover:text-black hover:underline">Blog</a>
                <span>/</span>
                <span class="text-dom-black bg-dom-yellow px-1 border border-black truncate max-w-[200px] md:max-w-none">
                    {breadcrumbName}
                </span>
            </nav>

            {/* BUTTON KATEGORI (BARU) */}
            <div class="mb-6">
                <a href={`/blog/${categorySlug}`} class="inline-block bg-dom-yellow border-2 border-black px-4 py-1 font-bold text-sm uppercase shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px] transition-all">
                    {data.category}
                </a>
            </div>

            <h1 class="text-3xl md:text-6xl font-bold mb-6 uppercase leading-tight text-dom-black">{data.title}</h1>
           
            <div class="flex items-center justify-center gap-4 text-sm font-bold">
               {authorData && (
                   <span class="flex items-center gap-2">
                       {authorData.avatar && <img src={authorData.avatar} class="w-6 h-6 rounded-full border border-black object-cover" alt={authorData.name} />}
                       <span>{authorData.name}</span>
                       <span class="w-1 h-1 bg-black rounded-full"></span>
                   </span>
               )}
               <span class="bg-white px-3 py-1 border-2 border-black shadow-neo-sm">
                 {new Date(data.publishedDate).toLocaleDateString('id-ID', { dateStyle: 'long' })}
               </span>
            </div>
        </div>
    </header>

    {/* Cover Image */}
    {data.coverImage && (
        <div class="container mx-auto px-6 max-w-5xl -mt-12 relative z-20">
            <div class="aspect-video border-3 border-dom-black shadow-neo bg-gray-200">
                <img src={data.coverImage} alt={data.title} class="w-full h-full object-cover" />
            </div>
        </div>
    )}

    <div class="container mx-auto px-6 py-16 max-w-3xl">
        <div class="prose md:prose-lg prose-headings:font-bold prose-headings:uppercase prose-a:text-dom-black prose-a:decoration-dom-yellow prose-img:border-2 prose-img:border-black max-w-none">
            <Content />
        </div>

        

        {/* ======================================================== */}
        {/* RATING SECTION (INTERACTIVE) */}
        {/* ======================================================== */}
            <div class="mt-16 bg-white p-8 text-center border-3 border-black shadow-neo relative overflow-hidden group">
                
                <h3 class="text-xl font-bold uppercase mb-2">Seberapa bermanfaat artikel ini?</h3>
                <p class="mb-6 text-gray-500 text-sm">Bantu kami meningkatkan kualitas konten dengan memberi rating.</p>
                
                {/* Star Widget */}
                <div class="flex justify-center gap-2 mb-4" id="star-container">
                    {[1, 2, 3, 4, 5].map((star) => (
                        <button 
                            data-star={star}
                            class="star-btn transition-transform hover:scale-125 focus:outline-none text-gray-300 hover:text-dom-yellow"
                            aria-label={`Beri bintang ${star}`}
                        >
                            <svg class="w-10 h-10 fill-current" viewBox="0 0 24 24">
                                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                            </svg>
                        </button>
                    ))}
                </div>

                {/* Feedback Message (Hidden by default) */}
                <div id="rating-feedback" class="hidden animate-in fade-in zoom-in duration-300">
                    <p class="font-bold text-green-600 mb-2">Terima kasih atas penilaian Anda!</p>
                    <p class="text-xs text-gray-400">Rating Anda membantu pembaca lain.</p>
                </div>

                {/* Microcopy Data (Real-Time from KV) */}
                <p class="text-xs font-bold uppercase tracking-widest text-gray-400 mt-6">
                    Rating saat ini: <span class="text-black">{currentRating}/5</span> 
                    <span class="mx-1">â€¢</span> 
                    {reviewCount} Votes
                </p>

            </div>

        <div class="mt-8 pt-8 border-t-2 border-black border-dashed">
        {/* Author Section */}
        {authorData && (
            <div class="mb-8 border-3 border-dom-black p-6 md:p-8 bg-zinc-50 shadow-neo">
                <div class="flex flex-col md:flex-row gap-6 items-center md:items-start text-center md:text-left">
                    <div class="flex-shrink-0">
                        {authorData.avatar ? (
                            <img src={authorData.avatar} alt={authorData.name} class="w-24 h-24 md:w-32 md:h-32 object-cover border-2 border-dom-black shadow-neo-sm bg-white" />
                        ) : (
                            <div class="w-24 h-24 md:w-32 md:h-32 bg-dom-yellow border-2 border-dom-black flex items-center justify-center text-3xl font-bold shadow-neo-sm">
                                {authorData.name.charAt(0)}
                            </div>
                        )}
                    </div>
                    
                    <div class="flex-grow">
                        <div class="mb-1 text-xs font-bold uppercase tracking-widest text-gray-500">Tentang Penulis</div>
                        <h3 class="text-2xl font-bold uppercase mb-1">{authorData.name}</h3>
                        {authorData.role && <p class="text-sm font-bold text-dom-yellow bg-dom-black inline-block px-2 py-0.5 mb-4">{authorData.role}</p>}
                        {authorData.bio && <p class="text-gray-700 mb-4 leading-relaxed">{authorData.bio}</p>}
                    </div>
                </div>
            </div>
        )}
        </div>

    </div>
  </article>

  {/* SCRIPT CLIENT SIDE (Kirim Data ke API) */}
  <script define:vars={{ slug }}>
    const stars = document.querySelectorAll('.star-btn');
    const container = document.getElementById('star-container');
    const feedback = document.getElementById('rating-feedback');

    stars.forEach(star => {
        // Hover Effect
        star.addEventListener('mouseenter', () => {
            const val = parseInt(star.getAttribute('data-star'));
            highlightStars(val);
        });

        // Click Effect (Submit Vote)
        star.addEventListener('click', async () => {
            const val = parseInt(star.getAttribute('data-star'));
            
            // 1. Lock UI (Visual)
            stars.forEach(s => {
                s.disabled = true;
                s.classList.remove('hover:scale-125');
                s.classList.add('cursor-default');
            });
            
            // Update warna visual sesuai pilihan
            highlightStars(val);

            // 2. Show Feedback
            if(feedback) feedback.classList.remove('hidden');

            // 3. KIRIM DATA KE API (KV)
            try {
                const response = await fetch('/api/rate', {
                    method: 'POST',
                    body: JSON.stringify({ slug: slug, rating: val }),
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error('Network response was not ok');
                
                // Opsional: Anda bisa update angka vote di UI secara live di sini jika mau
                console.log(`Vote success: ${val} stars`);
            } catch (error) {
                console.error("Gagal mengirim vote:", error);
            }
        });
    });

    // Reset saat mouse leave (jika belum diklik)
    container?.addEventListener('mouseleave', () => {
        const isClicked = stars[0].disabled;
        if (!isClicked) {
            removeHighlight();
        }
    });

    function highlightStars(count) {
        stars.forEach(s => {
            const sVal = parseInt(s.getAttribute('data-star'));
            if (sVal <= count) {
                s.classList.add('text-dom-yellow');
                s.classList.remove('text-gray-300');
            } else {
                s.classList.remove('text-dom-yellow');
                s.classList.add('text-gray-300');
            }
        });
    }

    function removeHighlight() {
        stars.forEach(s => {
            s.classList.remove('text-dom-yellow');
            s.classList.add('text-gray-300');
        });
    }
  </script>

</Layout>